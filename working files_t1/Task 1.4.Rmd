---
title: "Task 1.4"
author: "Franco Bastida"
date: "2024-12-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The 20 most popular Scottish MSPs of the 6th session
(MSP = member of Scottish Parliament)

Create a gt/gtExtras table that reports the top 20 most visited Wikipedia pages on
average from Scottish MSPs of the 6th legislative session, following good practice of
visualization. For this task, consider the following:
- focus only on traffic following May 13, 2021.
- your table should contain the following information: (1) The name and party of the
MSP, (2) the mean and standard deviation of the visits during the time period, and
(3) a histogram displaying the distribution of page traffic with a binwidth of 1000.
- the average traffic column should be colored by value.
- the table should provide a meaningful title and description, making it a standalone
product that speaks for itself.

```{r}
pacman::p_load(legislatoR, dplyr, haven, descr, gt, gtExtras, ggplot2, htmltools, purrr, sparkline)
```

## Data preparation and joining:
```{r}
#Loading the necessary dafa frames
sco_core <- get_core(legislature = "sco")
sco_political <- get_political(legislature = "sco")
sco_traffic <- get_traffic(legislature = "sco")

#Filtering according to the necessary specifications for session 6
sco_political <- subset(sco_political, sco_political$session == "6")

#Filtering for date, following May 13, 2021
sco_traffic <- subset(sco_traffic, sco_traffic$date >= "2021-05-13")

#Joining both the political and traffic data frames into the core one
sco_combined <- left_join(x = sco_core,
y = sco_political,
by = "pageid")

sco_combined <- left_join(x = sco_combined,
y = sco_traffic,
by = "pageid")

#Calculation of the mean and standard deviation
sco_most_visited <- sco_combined %>%
	group_by(pageid, name, party) %>%
	summarize(
		mean_traffic = round(mean(traffic, na.rm = TRUE), 2),
		sd_traffic = round(sd(traffic, na.rm = TRUE), 2),
		traffic_values = list(traffic)
	) %>%
	ungroup()

#Further subsetting for the table, including a Not Affiliated category for NAs
sco_most_visited <- subset(sco_most_visited, !is.na(sd_traffic))

sco_most_visited <- subset(sco_most_visited, !is.na(party))

#Filtered MSPs without party (although a Google search shows some did have one)
head_sco_combined <- sco_most_visited %>%
  arrange(desc(mean_traffic)) %>% 
  head(20)    
```

## GT extras table:
```{r}
sco_most_visited_df <- head_sco_combined %>%
  mutate(traffic_values = purrr::map(traffic_values, ~ as.numeric(.x))) %>%
  select(name, party, mean_traffic, sd_traffic, traffic_values)

#Here, dimensions had to be optimized.
#The bin width could be adjusted but was left at 1000 per the instructions.
sco_most_visited_gt <- sco_most_visited_df %>%
  gt() %>%
  tab_header(
    title = "Top 20 Most Visited Wikipedia Pages of Scottish MSPs",
    subtitle = "Timeframe: From May 15, 2021 and on; 6th Parliamentary Session Only. Source: LegislatoR package."
  ) %>%
  fmt_number(
    columns = c(mean_traffic, sd_traffic),
    decimals = 2
  ) %>%
  gtExtras::gt_plt_dist(
    column = traffic_values,
    type = "histogram",
    fig_dim = c(12, 20),
    bw = 1000,
  ) %>%
  data_color(
    columns = mean_traffic,
    colors = scales::col_numeric(
      palette = c("lightblue", "darkgreen"),
      domain = NULL
    )
  ) %>%
  cols_label(
    name = "Name",
    party = "Party",
    mean_traffic = "Mean Traffic",
    sd_traffic = "Standard Deviation",
    traffic_values = "Traffic Histogram"
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_column_labels(everything())
  )

sco_most_visited_gt
```


