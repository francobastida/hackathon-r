---
title: "Task 1_ auf-deutsch-espanol"
author: Lisa Rabba [234161@students.hertie-school.org](234161@students.hertie-school.org), Elena Murray [235549@students.hertie-school.org](235549@students.hertie-school.org), Franco Bastida [239793@students.hertie-school.org](239793@students.hertie-school.org)[(our repo)](https://github.com/intro-to-data-science-24/hackathon-project-auf-deutsch-espanol)
output: html_document
date: "2024-12-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Disclaimer:** The team used ChatGPT or Claude to correct errors we were unable to resolve ourselves, and for help re-ordering the variables using the forcats package. 

Load packages:
```{r}
pacman::p_load(legislatoR, tidyr, dplyr, leaflet, sf, jsonlite, RColorBrewer, htmlwidgets, tigris, viridis, lubridate, ggridges, ggplot2, forcats, hms, gt, gtExtras, htmltools, purrr, sparkline)
```

# Task 1.1 Interactive map of US Senator birthplaces

### Step 1. Data preparation from core data sources:
```{r}
#Data preparation, excluding Sen. with NA birthplace
core_usa_senate <- get_core(legislature = "usa_senate") %>%
  filter(!is.na(birthplace)) %>%
  separate(birthplace, into = c("lat", "lng"), sep = ",", convert = TRUE)
  
head(core_usa_senate)
```
### Step 2. Loading of basic US-map with tiles (based on Leaflet Workshop):
```{r}
#Load the GeoJSON Data of the US states
polygon_data <- read_sf("data/us-states.json")

#Set US-map tile with Mapnik
Map_usa <- leaflet() %>%
  setView(lng = -96, lat = 37.8, zoom = 3.5) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addPolygons(data = polygon_data, color = "blue", stroke = 1, opacity = 0.8)

```

### Step 3. Data join and clean up for interactive map:
```{r}
#Converting senate data into sf objects
usa_senate_sf <- st_as_sf(core_usa_senate, coords = c("lng", "lat"), crs = 4326, remove = FALSE)

#Spatial join to assign each Sen. to a polygon
states_sf <- states(cb = TRUE) %>%  
  st_transform(crs = 4326) 

birthplace_with_state <- st_join(usa_senate_sf, states_sf, join = st_within)

#Counting Senators by state
senator_by_state <- birthplace_with_state %>%
  filter(!is.na(NAME)) %>%  #Removing NAs
  group_by(NAME) %>%        #
  summarize(senator_count = n())

#Rejoin to be able to produce map
senator_by_state_df <- senator_by_state %>%
  st_drop_geometry()

aggregated_senator_states <- left_join(birthplace_with_state, senator_by_state_df, by = c("NAME"))

#Data clean up
aggregated_senator_states <- aggregated_senator_states %>% 
  rename(state = NAME)
         
aggregated_senator_summary <- aggregated_senator_states %>%
    group_by(name, state) %>%
    summarize(
      id = STUSPS,
      NAME = state,
        lat = lat,
        lng = lng,
        `total senators` = senator_count,
        geometry = geometry
    )
```


### Step 4. Generation of interactive map with Leaflet:
```{r}
aggregated_senator_summary_df <- aggregated_senator_summary %>%
  st_drop_geometry()

polygon_data <- polygon_data %>%
  left_join(aggregated_senator_summary_df, by = c("id" = "id")) %>%
  mutate(   `total senators` = ifelse(is.na(`total senators`), 0, `total senators`))

pal <- colorNumeric(
  palette = "viridis",
  domain = polygon_data$`total senators`,
  na.color = "transparent" 
)

polygon_data <- polygon_data %>%
  mutate(
    popup_info = paste0("<b>", state, ":</b> ", `total senators`, " Senators")
  )

#Load the GeoJSON Data of the US states
map_usa <- leaflet(polygon_data) %>%
  setView(lng = -96, lat = 37.8, zoom = 4) %>%  # Center the map
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>% 
  addPolygons(
    fillColor = ~pal(`total senators`),   
    weight = 1,                         
    color = "white",                    
    fillOpacity = 0.6,
    popup = ~popup_info, 
    highlightOptions = highlightOptions(
      weight = 2, color = "blue", bringToFront = TRUE
    )
  ) %>%
  addLegend(
    position = "bottomleft",
    pal = pal,
    values = ~`total senators`,
    title = "Senator Birthplaces (Since 1789)",
    opacity = 0.5
  )

map_usa
```

# Task 1.3 Interactive map of US Senator birthplaces

### Step 1. Data preparation from the core and political data sources:
```{r}
#Loading of core and political data for Ireland
irl_data <- get_core(legislature = "irl")

irl_political <- get_political(legislature = "irl")

#Joining the both data frames 
irl_politicians <- left_join(x = irl_political,
y = irl_data,
by = "pageid")

#Getting Wikipedia history data and repeating the process
irl_history <- get_history(legislature = "irl")

irl_fulldata <- left_join(x = irl_history,
y = irl_politicians,
by = "pageid")

```

### Step 2. Establish a subset of TDs from the Irish Dáil Éireann's 11th legislative session:
```{r}
#Subset to TDs from the 11th session
irl_fulldata_11 <- irl_fulldata %>% 
  filter(session == "11")

```

### Step 2. Establish a subset of TDs from the Irish Dáil Éireann's 11th legislative session:
```{r}
#Subset to TDs from the 11th session
irl_fulldata_11 <- irl_fulldata %>% 
  filter(session == "11")

```

### Step 3: Report the data and editors’ local times, updating to Dublin time.

**Note:** We assume all edits are made in Ireland - that means that the time zone is adjusted as such (which automatically accounts for daylight savings time as well.)

```{r}
#Convert the timestamp to Dublin time using Lubridate, then filter for only weekdays
irl_fulldata_filtered <- irl_fulldata_11 %>%
  mutate(timestamp_dublin = with_tz(timestamp, tzone = "Europe/Dublin")) %>% 
  mutate(day_of_week = wday(timestamp_dublin, label = T)) %>% 
  mutate(time = as_hms(timestamp_dublin)) %>% 
  filter(day_of_week %in% c("Mon", "Tue", "Wed", "Thu", "Fri")) %>% 
  mutate(day_of_week = fct_recode(day_of_week,
    "Monday" = "Mon",
    "Tuesday" = "Tue",
    "Wednesday" = "Wed",
    "Thursday" = "Thu",
    "Friday" = "Fri",
    "Saturday" = "Sat",
    "Sunday" = "Sun")) %>% 
  mutate(day_of_week = fct_rev(day_of_week)) 

```

### Step 4: Create the Plot, with quartile and color specifications:
```{r}
#Plot the graph 
ggplot(irl_fulldata_filtered, aes(x = time, y = day_of_week, fill = factor(stat(quantile)))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE,
    scale = 1.2
  ) +
  scale_fill_brewer(palette = "Blues", name = "Quartiles") +
  theme_ridges(center_axis_labels = TRUE) +
  scale_x_time(
    name = "Time of Day",
    limits = c(hms::as_hms("00:00:00"), hms::as_hms("24:00:00")),
    breaks = hms::as_hms(c("00:00:00", "06:00:00", "12:00:00", "18:00:00", "24:00:00")),
    labels = c("0:00", "6:00", "12:00", "18:00", "24:00"),
) +
  scale_y_discrete(
    name = "Day of the Week",
    expand = expand_scale(mult = c(0.05, 0.3))) +
  labs(
    title = "Wikipedia Edits by Time of Day in Ireland (Weekdays)",
    subtitle = "This graph shows at what time of the day edits to Wikipedia pages of Irish \n TDs in the 11th session of the Irish Dáil Éireann are made (on weekdays). \n The times shown are in GMT. Source: LegislatoR package.")

```

# Task 1.4 The 20 most popular Scottish MSPs of the 6th session

### Step 1. Data preparation and joining:
```{r}
#Loading the necessary data frames
sco_core <- get_core(legislature = "sco")
sco_political <- get_political(legislature = "sco")
sco_traffic <- get_traffic(legislature = "sco")

#Filtering according to the necessary specifications for session 6
sco_political <- subset(sco_political, sco_political$session == "6")

#Filtering for date, following May 13, 2021
sco_traffic <- subset(sco_traffic, sco_traffic$date >= "2021-05-13")

#Joining both the political and traffic data frames into the core one
sco_combined <- left_join(x = sco_core,
y = sco_political,
by = "pageid")

sco_combined <- left_join(x = sco_combined,
y = sco_traffic,
by = "pageid")

#Calculation of the mean and standard deviation
sco_most_visited <- sco_combined %>%
	group_by(pageid, name, party) %>%
	summarize(
		mean_traffic = round(mean(traffic, na.rm = TRUE), 2),
		sd_traffic = round(sd(traffic, na.rm = TRUE), 2),
		traffic_values = list(traffic)
	) %>%
	ungroup()

#Further subsetting for the table, including a Not Affiliated category for NAs
sco_most_visited <- subset(sco_most_visited, !is.na(sd_traffic))

sco_most_visited <- subset(sco_most_visited, !is.na(party))

#Filtered MSPs without party (although a Google search shows some did have one)
head_sco_combined <- sco_most_visited %>%
  arrange(desc(mean_traffic)) %>% 
  head(20)    
```

### Step 2. Generation of GT extras table:
```{r}
#Claude LLM was used to adequately format histograms.
sco_most_visited_df <- head_sco_combined %>%
  mutate(traffic_values = purrr::map(traffic_values, ~ as.numeric(.x))) %>%
  select(name, party, mean_traffic, sd_traffic, traffic_values)

#Here, dimensions had to be optimized.
#The bin width could be adjusted but was left at 1000 per the instructions.
sco_most_visited_gt <- sco_most_visited_df %>%
  gt() %>%
  tab_header(
    title = "Top 20 Most Visited Wikipedia Pages of Scottish MSPs by Traffic",
    subtitle = "Timeframe: From May 15, 2021 and on; 6th Parliamentary Session only. Source: LegislatoR package."
  ) %>%
  fmt_number(
    columns = c(mean_traffic, sd_traffic),
    decimals = 2
  ) %>%
  gtExtras::gt_plt_dist(
    column = traffic_values,
    type = "histogram",
    fig_dim = c(15, 75),
    bw = 1000,
  ) %>%
  data_color(
    columns = mean_traffic,
    colors = scales::col_numeric(
      palette = c("lightblue", "darkgreen"),
      domain = NULL
    )
  ) %>%
  cols_label(
    name = "Name",
    party = "Party",
    mean_traffic = "Mean Traffic",
    sd_traffic = "Standard Deviation",
    traffic_values = "Traffic Histogram"
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_column_labels(everything())
  )

sco_most_visited_gt
```
